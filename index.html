<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Research Assistant</title>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">Research Assistant</div>
    <div id="chatbox" class="chat-box"></div>

    <div class="input-area">
        <input id="userInput" type="text" placeholder="Ask a research question..." />
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
async function sendMessage() {
    const input = document.getElementById("userInput");
    const chatbox = document.getElementById("chatbox");
    const question = input.value.trim();
    if (!question) return;

    // User Message
    chatbox.innerHTML += `<div class='msg user-msg'>${question}</div>`;
    input.value = "";

    // Loading Message
    const responseDiv = document.createElement("div");
    responseDiv.className = "msg bot-msg";
    responseDiv.textContent = "Thinking...";
    chatbox.appendChild(responseDiv);
    chatbox.scrollTop = chatbox.scrollHeight;

    try {
        const res = await fetch(`/api/ask?question=${encodeURIComponent(question)}`);
        const data = await res.json();

        // FIX 2: Use Marked to parse the AI Answer (handles bolding, lists)
        // We expect data.answer to be the text
        let formattedAnswer = marked.parse(data.answer || "No answer found.");

        // FIX 3: Generate Source Cards if they exist
        let sourcesHtml = "";
        if (data.sources && data.sources.length > 0) {
            sourcesHtml = `<div class="sources-container"><strong>Sources:</strong><div class="sources-list">`;
            data.sources.forEach(src => {
                // Use hostname if description is too long or empty
                let label = src.description ? src.description.split('-')[0] : new URL(src.url).hostname;
                sourcesHtml += `<a href="${src.url}" target="_blank" class="source-card">${label}</a>`;
            });
            sourcesHtml += `</div></div>`;
        }

        // Combine Answer + Sources
        responseDiv.innerHTML = formattedAnswer + sourcesHtml;

    } catch (error) {
        responseDiv.textContent = "Error: Could not fetch response.";
    }

    chatbox.scrollTop = chatbox.scrollHeight;
}
</script>

<button id="feedbackBtn" class="feedback-trigger" onclick="openModal()">
    üí¨ Feedback
</button>

<div id="feedbackModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h3>Help us improve!</h3>
        <p>What should we fix or add next?</p>
        
        <select id="fbRating">
            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Excellent)</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (Good)</option>
            <option value="3">‚≠ê‚≠ê‚≠ê (Average)</option>
            <option value="2">‚≠ê‚≠ê (Poor)</option>
            <option value="1">‚≠ê (Terrible)</option>
        </select>

        <textarea id="fbComment" placeholder="Describe the bug or feature request here..."></textarea>
        
        <button onclick="submitFeedback()">Submit Feedback</button>
        <div id="fbStatus"></div>
    </div>
</div>

<script>
    const modal = document.getElementById("feedbackModal");

    function openModal() {
        modal.style.display = "flex";
    }

    function closeModal() {
        modal.style.display = "none";
        document.getElementById("fbStatus").textContent = "";
    }

    // Close if user clicks outside the box
    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    async function submitFeedback() {
        const rating = document.getElementById("fbRating").value;
        const comment = document.getElementById("fbComment").value;
        const statusDiv = document.getElementById("fbStatus");

        if (!comment) {
            statusDiv.textContent = "Please write a comment.";
            statusDiv.style.color = "red";
            return;
        }

        statusDiv.textContent = "Sending...";

        try {
            const res = await fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rating: parseInt(rating), comment: comment })
            });

            if (res.ok) {
                statusDiv.textContent = "Thank you! Saved.";
                statusDiv.style.color = "#4caf50";
                setTimeout(closeModal, 2000); // Close automatically after 2s
                document.getElementById("fbComment").value = ""; // Clear form
            } else {
                statusDiv.textContent = "Error sending feedback.";
            }
        } catch (e) {
            console.error(e);
            statusDiv.textContent = "Network Error.";
        }
    }
</script>

</body>
</html>